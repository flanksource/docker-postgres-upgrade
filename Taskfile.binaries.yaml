version: "3"

# Binary Installation Taskfile using eget
# Handles GitHub releases for Task, PostgREST, and WAL-G

vars:
  # Version variables for easy updates
  EGET_VERSION: 1.3.4
  TASK_VERSION: 3.44.1
  POSTGREST_VERSION: 12.2.3
  WALG_VERSION: 3.0.5
  TARGET_BIN: /usr/local/bin

  # Architecture detection
  ARCH:
    sh: dpkg --print-architecture

tasks:
  # Bootstrap eget for downloading GitHub releases
  install-eget:
    desc: Install eget for downloading GitHub releases
    cmds:
      - |
        EGET_URL="https://github.com/zyedidia/eget/releases/download/v{{.EGET_VERSION}}/eget-{{.EGET_VERSION}}-linux_{{.ARCH}}.tar.gz"
        curl -fsSL "${EGET_URL}" | tar -xzC /tmp
        install /tmp/eget {{.TARGET_BIN}}/eget
        rm -f /tmp/eget
    status:
      - test -x {{.TARGET_BIN}}/eget

  # Install Task using eget
  install-task:
    desc: Install Task using eget
    deps: [install-eget]
    cmds:
      - eget go-task/task --tag v{{.TASK_VERSION}} --asset "*.tar.gz" --to {{.TARGET_BIN}}
    status:
      - test -x {{.TARGET_BIN}}/task

  # Install PostgREST using eget
  install-postgrest:
    desc: Install PostgREST using eget
    deps: [install-eget]
    cmds:
      - eget PostgREST/postgrest --tag v{{.POSTGREST_VERSION}} --to {{.TARGET_BIN}}
      - chmod +x {{.TARGET_BIN}}/postgrest
    status:
      - test -x {{.TARGET_BIN}}/postgrest

  # Install WAL-G using eget
  install-walg:
    desc: Install WAL-G using eget
    deps: [install-eget]
    cmds:
      - eget wal-g/wal-g --tag v{{.WALG_VERSION}} --asset "wal-g-pg-ubuntu-20.04" --asset '{{.ARCH | replace "arm64" "aarch64" }}' --asset "tar.gz" --to {{.TARGET_BIN}}/wal-g
    status:
      - test -x {{.TARGET_BIN}}/wal-g

  # Install all binaries
  install-all:
    desc: Install all binary tools
    cmds:
      - task: install-eget
      - task: install-task
      - task: install-postgrest
      - task: install-walg

  # Verify installations
  verify:
    desc: Verify all binaries are installed and working
    cmds:
      - |
        echo "=== Binary Installation Verification ==="
        echo -n "eget: "; eget --version || echo "❌ NOT FOUND"
        echo -n "task: "; task --version || echo "❌ NOT FOUND"
        echo -n "postgrest: "; postgrest --version || echo "❌ NOT FOUND"
        echo -n "wal-g: "; wal-g --version || echo "❌ NOT FOUND"
        echo -n "supervisord: "; supervisord --version || echo "❌ NOT FOUND"
        echo "=== Verification Complete ==="

  # Clean up temporary files
  cleanup:
    desc: Clean up temporary installation files
    cmds:
      - rm -rf /tmp/eget* /tmp/*.tar.gz /tmp/*.tar.xz
