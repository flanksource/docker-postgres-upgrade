[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
loglevel=debug

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# PostgreSQL - Primary service that others depend on
[program:postgresql]
command=/usr/local/bin/postgresql-service.sh
directory=/var/lib/postgresql
user=root
autostart=true
autorestart=true
priority=100
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
stdout_logfile_backups=0
stderr_logfile_backups=0
stdout_events_enabled=true
stderr_events_enabled=true
startsecs=10
stopwaitsecs=30
killasgroup=true
stopasgroup=true

# PgBouncer - Connection pooler (depends on PostgreSQL)
[program:pgbouncer]
command=/usr/local/bin/pgbouncer-service.sh
directory=/var/lib/postgresql
user=root
autostart=%(ENV_PGBOUNCER_ENABLED)s
autorestart=true
priority=200
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
stdout_logfile_backups=0
stderr_logfile_backups=0
stdout_events_enabled=true
stderr_events_enabled=true
startsecs=15
stopwaitsecs=10

# PostgREST - REST API server (depends on PostgreSQL)
[program:postgrest]
command=/usr/local/bin/postgrest-service.sh
directory=/var/lib/postgresql
user=root
autostart=%(ENV_POSTGREST_ENABLED)s
autorestart=true
priority=200
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
stdout_logfile_backups=0
stderr_logfile_backups=0
stdout_events_enabled=true
stderr_events_enabled=true
startsecs=15
stopwaitsecs=10

# WAL-G - Backup service (depends on PostgreSQL)
[program:walg]
command=/usr/local/bin/walg-service.sh
directory=/var/lib/postgresql
user=postgres
autostart=%(ENV_WALG_ENABLED)s
autorestart=true
priority=300
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
stdout_logfile_backups=0
stderr_logfile_backups=0
stdout_events_enabled=true
stderr_events_enabled=true
startsecs=5
stopwaitsecs=10

# Health Service - HTTP health check endpoints (depends on other services)
[program:health]
command=/usr/local/bin/health-service.sh
directory=/var/lib/postgresql
user=root
autostart=%(ENV_HEALTH_SERVICE_ENABLED)s
autorestart=true
priority=400
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
stdout_logfile_backups=0
stderr_logfile_backups=0
stdout_events_enabled=true
stderr_events_enabled=true
startsecs=5
stopwaitsecs=10

# Service group for all PostgreSQL-related services
[group:postgres-services]
programs=postgresql,pgbouncer,postgrest,walg,health
priority=999
